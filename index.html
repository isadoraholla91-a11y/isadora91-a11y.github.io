<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luna: Din Sissy-Veileder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f7fa;
        }
        .bg-luna-pink-deep { background-color: #d81b60; }
        .text-luna-pink-deep { color: #d81b60; }
        .border-luna-pink-deep { border-color: #d81b60; }
        .bg-luna-purple-soft { background-color: #ab47bc; }
        .text-luna-purple-soft { color: #ab47bc; }
        .bg-luna-green { background-color: #43a047; }
        .text-luna-green { color: #43a047; }
        
        .page { display: none; }
        .page.active { display: block; }

        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: #f1f1f1; }
        .chat-messages::-webkit-scrollbar-thumb { background: #c4b5fd; border-radius: 6px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: #a78bfa; }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ab47bc;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #offline-indicator {
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl flex flex-col">
        
        <!-- Topp Header -->
        <header class="p-4 flex justify-between items-center bg-white border-b border-gray-200 sticky top-0 z-20">
            <div>
                <h1 class="text-xl font-bold text-luna-purple-soft">Luna</h1>
                <p class="text-sm text-gray-500">Din Sissy-Veileder</p>
            </div>
             <div class="text-right">
                <p class="font-semibold text-luna-pink-deep">Nivå <span id="level-display-header">1</span></p>
                <p class="text-sm text-gray-500"><span id="points-display-header">50</span> poeng</p>
            </div>
        </header>
        
        <!-- Offline Indikator -->
        <div id="offline-indicator" class="bg-gray-700 text-white text-center py-1 text-xs opacity-0 transform -translate-y-full fixed top-0 w-full max-w-md z-10">
            Du er offline. AI-funksjoner er deaktivert.
        </div>

        <main class="flex-grow p-4 overflow-y-auto">
            <!-- Hjem Siden -->
            <div id="page-hjem" class="page active">
                <div class="text-center mb-8">
                    <div class="relative w-48 h-48 mx-auto bg-gradient-to-br from-purple-200 to-pink-200 rounded-full flex flex-col justify-center items-center shadow-lg">
                        <p class="text-gray-600 text-sm">Nåværende Poengsum</p>
                        <p id="points-display-main" class="text-5xl font-bold text-luna-pink-deep">50</p>
                    </div>
                </div>
                <div class="text-center mb-8">
                    <h2 class="text-lg font-semibold text-gray-700">Neste Task:</h2>
                    <p id="next-task-display" class="text-xl text-luna-purple-soft">Kjenn BHen</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg text-center">
                    <p id="motivational-quote" class="text-gray-600 italic">"Hver minste bevegelse former din Isadora. Du er vakker i din dedikasjon."</p>
                </div>
            </div>

            <!-- Daglige Tasks Siden -->
            <div id="page-tasks" class="page">
                <h2 class="text-2xl font-bold mb-4 text-luna-purple-soft">Mine Daglige Tasks</h2>
                <div id="task-list" class="space-y-3"></div>
            </div>

            <!-- Poeng & Belønninger Siden -->
            <div id="page-rewards" class="page">
                <h2 class="text-2xl font-bold mb-4 text-luna-purple-soft">Poeng & Belønninger</h2>
                <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-lg">Totalt: <span id="rewards-points-total" class="text-luna-pink-deep">50</span> poeng</span>
                        <span class="text-sm text-gray-500">Neste Nivå: <span id="next-level-target">1000</span>p</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="level-progress-bar" class="bg-gradient-to-r from-pink-400 to-purple-500 h-4 rounded-full" style="width: 5%"></div>
                    </div>
                    <p class="text-center text-sm mt-1">Nivå <span id="rewards-level">1</span>: Nybegynner Sissy</p>
                </div>
                <h3 class="text-xl font-semibold mb-3">Belønningsbutikk</h3>
                <div id="rewards-store" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            
            <!-- Inspirasjon Siden -->
            <div id="page-inspiration" class="page">
                <h2 class="text-2xl font-bold mb-4 text-luna-purple-soft">Visuell Inspirasjon <span class="ai-feature-indicator text-base">✨</span></h2>
                <div class="space-y-6">
                    <div>
                        <p class="text-sm text-gray-600 mb-3">Lagre et bilde fra Pinterest som inspirerer deg, og last det opp her. Luna vil se på det og skape en personlig utfordring bare for deg.</p>
                        <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <img id="image-preview" class="hidden max-h-48 mx-auto rounded-lg mb-4" alt="Forhåndsvisning av bilde"/>
                            <label for="image-upload" class="w-full flex items-center justify-center px-4 py-3 bg-luna-pink-deep text-white rounded-lg cursor-pointer hover:bg-pink-700 transition-colors">
                                <i data-lucide="image-plus" class="mr-2"></i>
                                <span id="upload-label">Velg et bilde</span>
                            </label>
                            <input id="image-upload" type="file" class="hidden" accept="image/*">
                        </div>
                        <button id="generate-inspiration-button" class="ai-button w-full mt-4 px-4 py-3 bg-luna-purple-soft text-white rounded-lg hover:bg-purple-600 transition-colors flex items-center justify-center disabled:bg-purple-300 disabled:cursor-not-allowed" disabled>
                            <i data-lucide="sparkles" class="mr-2"></i>
                            Lag utfordring fra bilde
                        </button>
                    </div>
                    <div id="inspiration-challenge-container" class="mt-4"></div>
                </div>
            </div>
            
            <!-- Dokumentasjon Siden -->
            <div id="page-docs" class="page">
                <h2 class="text-2xl font-bold mb-4 text-luna-purple-soft">Dokumentasjon</h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Min Isadora-Dagbok</h3>
                        <textarea id="diary-entry" class="w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent" placeholder="Skriv ned dine refleksjoner, følelser og erfaringer..."></textarea>
                        <div class="flex space-x-2 mt-2">
                            <button id="save-diary-button" class="flex-1 px-4 py-2 bg-luna-green text-white rounded-lg hover:bg-green-700 transition-colors">Lagre Notat</button>
                            <button id="get-reflection-button" class="ai-button flex-1 px-4 py-2 bg-luna-purple-soft text-white rounded-lg hover:bg-purple-600 transition-colors flex items-center justify-center disabled:bg-purple-300 disabled:cursor-not-allowed" disabled>
                                Få Lunas Refleksjon <span class="ai-feature-indicator text-base ml-1">✨</span>
                            </button>
                        </div>
                        <div id="reflection-container" class="mt-4 p-4 bg-purple-50 rounded-lg border-l-4 border-luna-purple-soft hidden"></div>
                    </div>
                     <div>
                        <h3 class="text-lg font-semibold mb-2">Min Historikk</h3>
                        <div id="history-gallery" class="bg-gray-50 p-3 rounded-lg min-h-[100px]">
                           <p class="text-gray-400">Dine lagrede notater vil vises her.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Luna Chat Siden -->
            <div id="page-chat" class="page h-full flex flex-col">
                <h2 class="text-2xl font-bold mb-4 text-luna-purple-soft">Chat med Luna <span class="ai-feature-indicator text-base">✨</span></h2>
                <div class="flex-grow bg-gray-50 rounded-lg p-4 overflow-y-auto chat-messages flex flex-col space-y-4"></div>
                <div class="mt-4 flex">
                    <input type="text" id="chat-input" class="flex-grow border border-gray-300 rounded-l-lg p-3 focus:ring-2 focus:ring-purple-400 focus:border-transparent" placeholder="Skriv din melding...">
                    <button id="chat-send" class="ai-button bg-luna-purple-soft text-white px-5 rounded-r-lg hover:bg-purple-600 transition-colors flex items-center justify-center">
                        <i data-lucide="send" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>
        </main>

        <!-- Bunn Navigasjon -->
        <nav class="w-full bg-white border-t border-gray-200 p-2 flex justify-around sticky bottom-0">
            <button data-page="hjem" class="nav-btn flex flex-col items-center text-luna-purple-soft p-2 rounded-lg"><i data-lucide="home"></i><span class="text-xs mt-1">Hjem</span></button>
            <button data-page="tasks" class="nav-btn flex flex-col items-center text-gray-500 p-2 rounded-lg"><i data-lucide="check-square"></i><span class="text-xs mt-1">Tasks</span></button>
            <button data-page="inspiration" class="nav-btn flex flex-col items-center text-gray-500 p-2 rounded-lg"><i data-lucide="camera"></i><span class="text-xs mt-1">Inspirasjon</span></button>
            <button data-page="rewards" class="nav-btn flex flex-col items-center text-gray-500 p-2 rounded-lg"><i data-lucide="star"></i><span class="text-xs mt-1">Belønninger</span></button>
            <button data-page="docs" class="nav-btn flex flex-col items-center text-gray-500 p-2 rounded-lg"><i data-lucide="file-text"></i><span class="text-xs mt-1">Dokumentasjon</span></button>
            <button data-page="chat" class="nav-btn flex flex-col items-center text-gray-500 p-2 rounded-lg"><i data-lucide="message-circle"></i><span class="text-xs mt-1">Chat</span></button>
        </nav>
    </div>

    <script type="module">
        lucide.createIcons();

        const appState = {
            points: 50,
            level: 1,
            levelName: "Nybegynner Sissy",
            tasks: {
                morgen: { name: "Morgenrituale", details: "Kjenn BHen. Perfekt holdning: skuldre ned, rygg rett. Myke hender. Klar til å skinne. Affirmasjoner!", done: false, points: 10 },
                dag: { name: "Holdningssjekk", details: "Midt på dagen, sjekk holdningen din. Er ryggen rett? Er bevegelsene dine myke og feminine?", done: false, points: 10 },
                ettermiddag: { name: "Feminin Refleksjon", details: "Ta 5 minutter til å tenke på en feminin egenskap du beundrer og hvordan du kan uttrykke den.", done: false, points: 10 },
                kveld: { name: "Kveldspleie", details: "Ta vare på huden din. Bruk en fuktighetskrem, og nyt følelsen av mykhet.", done: false, points: 10 }
            },
            rewards: [
                { id: 1, name: "Virtuell Godkjenning", cost: 25, description: "Et anerkjennende nikk fra Luna for din innsats.", purchased: false },
                { id: 2, name: "Friminutt for Fantasi", cost: 100, description: "Tillatelse til 15 minutter med dagdrømming om din Isadora-fremtid.", purchased: false }
            ],
            diaryEntries: [],
            motivationalQuotes: [
                "Hver minste bevegelse former din Isadora. Du er vakker i din dedikasjon.",
                "Disiplin er broen mellom mål og virkelighet. Du bygger den nå.",
                "Omfavn mykheten. Den er din største styrke."
            ],
            levels: {
                1: { name: "Nybegynner Sissy", threshold: 0 },
                2: { name: "Dedikert Elev", threshold: 1000 },
                3: { name: "Blomstrende Isadora", threshold: 2500 },
            },
            chatHistory: [],
            inspirationImage: null
        };

        const apiKey = "";

        async function callGemini(prompt, history) {
            if (!navigator.onLine) return "Jeg trenger en internettforbindelse for å kunne tenke. Vennligst koble til og prøv igjen.";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            let contents = history ? [...history] : [];
            contents.push({ role: "user", parts: [{ text: prompt }] });
            return sendApiRequest(apiUrl, { contents });
        }
        
        async function callGeminiVision(prompt, base64ImageData) {
            if (!navigator.onLine) return "Jeg trenger en internettforbindelse for å kunne se. Vennligst koble til og prøv igjen.";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inline_data: { mime_type: "image/jpeg", data: base64ImageData } }
                    ]
                }]
            };
            return sendApiRequest(apiUrl, payload);
        }

        async function sendApiRequest(apiUrl, payload) {
             try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "Beklager, jeg klarte ikke å behandle det akkurat nå.";
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return "Det oppstod en feil. Sjekk konsollen.";
            }
        }

        const pages = document.querySelectorAll('.page');
        const navButtons = document.querySelectorAll('.nav-btn');
        const pointsDisplays = document.querySelectorAll('[id^="points-display-"]');
        const levelDisplays = document.querySelectorAll('[id^="level-display-"]');
        const taskListContainer = document.getElementById('task-list');
        const rewardsStoreContainer = document.getElementById('rewards-store');
        const levelProgressBar = document.getElementById('level-progress-bar');
        const nextLevelTargetDisplay = document.getElementById('next-level-target');
        const nextTaskDisplay = document.getElementById('next-task-display');
        const motivationalQuoteDisplay = document.getElementById('motivational-quote');

        function navigateTo(pageId) {
            pages.forEach(p => p.classList.toggle('active', p.id === `page-${pageId}`));
            navButtons.forEach(btn => {
                btn.classList.toggle('text-luna-purple-soft', btn.dataset.page === pageId);
                btn.classList.toggle('text-gray-500', btn.dataset.page !== pageId);
            });
        }

        function updateUI() {
            pointsDisplays.forEach(el => el.textContent = appState.points);
            levelDisplays.forEach(el => el.textContent = appState.level);
            
            const { level, points, levels } = appState;
            const currentLevelInfo = levels[level];
            const nextLevelInfo = levels[level + 1];

            if (nextLevelInfo && points >= nextLevelInfo.threshold) {
                appState.level++;
                appState.levelName = levels[appState.level].name;
                alert(`Gratulerer! Du har nådd Nivå ${appState.level}: ${appState.levelName}!`);
                updateUI(); // Recalculate progress
                return;
            }

            if (nextLevelInfo) {
                const progress = ((points - currentLevelInfo.threshold) / (nextLevelInfo.threshold - currentLevelInfo.threshold)) * 100;
                levelProgressBar.style.width = `${Math.max(0, Math.min(100, progress))}%`;
                nextLevelTargetDisplay.textContent = `${nextLevelInfo.threshold}p`;
                document.getElementById('rewards-level').textContent = level;
            } else {
                levelProgressBar.style.width = '100%';
                nextLevelTargetDisplay.textContent = 'Maks';
            }

            const firstUnfinishedTask = Object.values(appState.tasks).find(task => !task.done);
            nextTaskDisplay.textContent = firstUnfinishedTask ? firstUnfinishedTask.name : "Alle tasks fullført!";

            renderTasks();
            renderRewards();
        }

        function renderTasks() {
            taskListContainer.innerHTML = '';
            Object.entries(appState.tasks).forEach(([key, task]) => {
                const taskEl = document.createElement('div');
                taskEl.className = `p-4 rounded-lg flex items-center transition-all ${task.done ? 'bg-green-100 text-gray-500' : 'bg-white shadow-sm'}`;
                taskEl.innerHTML = `
                    <input type="checkbox" id="task-${key}" class="h-6 w-6 rounded-full border-gray-300 text-luna-pink-deep focus:ring-luna-purple-soft" ${task.done ? 'checked' : ''}>
                    <div class="ml-4 flex-grow">
                        <label for="task-${key}" class="font-semibold ${task.done ? 'line-through' : ''}">${task.name}</label>
                        <p class="text-sm">${task.details}</p>
                    </div>
                    <span class="font-bold text-luna-green">+${task.points}p</span>
                `;
                taskEl.querySelector('input').addEventListener('change', (e) => {
                    appState.tasks[key].done = e.target.checked;
                    appState.points += e.target.checked ? task.points : -task.points;
                    updateUI();
                });
                taskListContainer.appendChild(taskEl);
            });
        }
        
        function renderRewards() {
            rewardsStoreContainer.innerHTML = '';
            appState.rewards.forEach(reward => {
                const canAfford = appState.points >= reward.cost;
                const rewardEl = document.createElement('div');
                rewardEl.className = `p-4 rounded-lg shadow-sm flex flex-col justify-between ${reward.purchased ? 'bg-gray-200' : 'bg-white'}`;
                rewardEl.innerHTML = `
                    <div>
                        <h4 class="font-bold text-lg ${reward.purchased ? 'text-gray-500' : 'text-luna-purple-soft'}">${reward.name}</h4>
                        <p class="text-sm text-gray-600 mb-2">${reward.description}</p>
                    </div>
                    <button data-id="${reward.id}" class="buy-reward-btn w-full mt-3 py-2 px-4 rounded-lg text-white font-semibold transition-colors ${
                        reward.purchased ? 'bg-gray-400 cursor-not-allowed' : canAfford ? 'bg-luna-green hover:bg-green-600' : 'bg-gray-400 cursor-not-allowed'
                    }" ${reward.purchased || !canAfford ? 'disabled' : ''}>
                        ${reward.purchased ? 'Kjøpt' : `Kjøp for ${reward.cost}p`}
                    </button>
                `;
                rewardsStoreContainer.appendChild(rewardEl);
            });
        }
        
        rewardsStoreContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('buy-reward-btn')) {
                const reward = appState.rewards.find(r => r.id === parseInt(e.target.dataset.id));
                if (reward && !reward.purchased && appState.points >= reward.cost) {
                    appState.points -= reward.cost;
                    reward.purchased = true;
                    alert(`Du har låst opp "${reward.name}"!`);
                    updateUI();
                }
            }
        });
        
        // --- Chat ---
        const chatSendBtn = document.getElementById('chat-send');
        const chatInput = document.getElementById('chat-input');
        const chatMessagesContainer = document.querySelector('.chat-messages');

        function addChatMessage(message, sender, isLoading = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-start ${sender === 'user' ? 'justify-end' : ''}`;
            messageWrapper.innerHTML = `
                ${sender === 'luna' ? `<div class="w-10 h-10 rounded-full bg-luna-purple-soft flex items-center justify-center text-white font-bold mr-3 flex-shrink-0">L</div>` : ''}
                <div class="${sender === 'user' ? 'bg-luna-pink-deep text-white rounded-br-none' : 'bg-purple-100 text-gray-800 rounded-bl-none'} p-3 rounded-lg max-w-xs">
                    ${isLoading ? `<div class="loader"></div>` : `<p>${message.replace(/\n/g, '<br>')}</p>`}
                </div>
                ${sender === 'user' ? `<div class="w-10 h-10 rounded-full bg-pink-200 flex items-center justify-center text-pink-700 font-bold ml-3 flex-shrink-0">I</div>` : ''}
            `;
            if (isLoading) messageWrapper.id = 'loading-bubble';
            chatMessagesContainer.appendChild(messageWrapper);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
        
        async function handleChatSend() {
            const userInput = chatInput.value.trim();
            if (!userInput) return;
            
            chatInput.value = '';
            addChatMessage(userInput, 'user');
            appState.chatHistory.push({ role: "user", parts: [{ text: userInput }] });

            addChatMessage('', 'luna', true);
            
            const personaPrompt = `You are Luna, a supportive, elegant, and firm sissy guide. Your name is Luna. The user's name is Isadora. Continue this conversation in a motivating and feminine tone, speaking in Norwegian.`;
            const lunaResponse = await callGemini(`${personaPrompt}\n\n${userInput}`, appState.chatHistory.slice(0, -1));
            
            document.getElementById('loading-bubble')?.remove();
            addChatMessage(lunaResponse, 'luna');
            appState.chatHistory.push({ role: "model", parts: [{ text: lunaResponse }] });
        }

        chatSendBtn.addEventListener('click', handleChatSend);
        chatInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleChatSend());
        
        // --- Dokumentasjon ---
        const saveDiaryBtn = document.getElementById('save-diary-button');
        const diaryInput = document.getElementById('diary-entry');
        const historyGallery = document.getElementById('history-gallery');
        const getReflectionBtn = document.getElementById('get-reflection-button');
        const reflectionContainer = document.getElementById('reflection-container');

        diaryInput.addEventListener('input', () => getReflectionBtn.disabled = diaryInput.value.trim().length === 0);
        saveDiaryBtn.addEventListener('click', () => {
            const entryText = diaryInput.value.trim();
            if (entryText) {
                appState.diaryEntries.unshift({ type: 'diary', date: new Date(), content: entryText });
                diaryInput.value = '';
                getReflectionBtn.disabled = true;
                alert('Dagboknotat lagret!');
                renderHistory();
            }
        });

        getReflectionBtn.addEventListener('click', async () => {
            const entryText = diaryInput.value.trim();
            if (!entryText) return;

            reflectionContainer.classList.remove('hidden');
            reflectionContainer.innerHTML = '<div class="flex justify-center items-center"><div class="loader"></div><p class="ml-3">Luna reflekterer...</p></div>';
            
            const prompt = `You are Luna, a supportive sissy guide. The user, Isadora, has written this diary entry. Provide a short, encouraging, and insightful reflection on her feelings. Respond directly to Isadora in Norwegian. Diary Entry: "${entryText}"`;
            const reflectionText = await callGemini(prompt, null);

            reflectionContainer.innerHTML = `<p>${reflectionText.replace(/\n/g, '<br>')}</p>`;
        });
        
        function renderHistory() {
            historyGallery.innerHTML = appState.diaryEntries.length === 0 
                ? '<p class="text-gray-400">Dine lagrede notater vil vises her.</p>'
                : appState.diaryEntries.map(entry => `
                    <div class="bg-white p-3 rounded-lg shadow-sm mb-2">
                        <p class="text-sm text-gray-500">${entry.date.toLocaleString('no-NO')}</p>
                        <p class="mt-1">${entry.content.replace(/\n/g, '<br>')}</p>
                    </div>`).join('');
        }

        // --- Inspirasjon ---
        const imageUploadInput = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const uploadLabel = document.getElementById('upload-label');
        const generateInspirationBtn = document.getElementById('generate-inspiration-button');
        const inspirationChallengeContainer = document.getElementById('inspiration-challenge-container');

        imageUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    appState.inspirationImage = e.target.result.split(',')[1];
                    uploadLabel.textContent = file.name;
                    generateInspirationBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            }
        });

        generateInspirationBtn.addEventListener('click', async () => {
            if (!appState.inspirationImage) return;

            inspirationChallengeContainer.innerHTML = '<div class="flex justify-center items-center p-4"><div class="loader"></div><p class="ml-3">Luna ser på bildet ditt og tenker...</p></div>';
            
            const prompt = `Du er Luna, en kreativ og elegant sissy-veileder. Brukeren din, Isadora, har lastet opp et bilde for inspirasjon. Se nøye på bildet. Lag en unik, feminin og oppnåelig utfordring for henne basert på det du ser. Svar direkte til henne på norsk.`;
            const challengeText = await callGeminiVision(prompt, appState.inspirationImage);

            inspirationChallengeContainer.innerHTML = `<div class="p-4 rounded-lg bg-pink-50 border-l-4 border-luna-pink-deep"><p>${challengeText.replace(/\n/g, '<br>')}</p></div>`;
        });

        // --- Offline/Online Håndtering ---
        const offlineIndicator = document.getElementById('offline-indicator');
        const aiButtons = document.querySelectorAll('.ai-button');
        const aiIndicators = document.querySelectorAll('.ai-feature-indicator');

        function handleConnectionChange() {
            const isOnline = navigator.onLine;
            if (isOnline) {
                offlineIndicator.classList.add('opacity-0', '-translate-y-full');
                aiButtons.forEach(btn => btn.disabled = false);
                aiIndicators.forEach(ind => ind.classList.remove('hidden'));
                if (diaryInput.value.trim()) getReflectionBtn.disabled = false;
                if (!appState.inspirationImage) generateInspirationBtn.disabled = true;
            } else {
                offlineIndicator.classList.remove('opacity-0', '-translate-y-full');
                aiButtons.forEach(btn => btn.disabled = true);
                aiIndicators.forEach(ind => ind.classList.add('hidden'));
                addChatMessage("Du er nå offline. Jeg kan ikke chatte før du er tilkoblet igjen.", 'luna');
            }
        }
        
        window.addEventListener('online', handleConnectionChange);
        window.addEventListener('offline', handleConnectionChange);

        // --- Initialisering ---
        function initialize() {
            navButtons.forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.page)));
            appState.chatHistory.push({ role: "model", parts: [{ text: "Hei Isadora. Jeg er her for deg, drevet av en dypere forståelse. Hva tenker du på?" }] });
            chatMessagesContainer.innerHTML = '';
            appState.chatHistory.forEach(msg => addChatMessage(msg.parts[0].text, msg.role === 'model' ? 'luna' : 'user'));
            
            updateUI();
            handleConnectionChange();
        }

        initialize();
    </script>
</body>
</html>

